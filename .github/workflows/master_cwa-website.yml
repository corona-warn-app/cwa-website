name: Deploy Website Digital Cuisine
# Test locally with act -P ubuntu-latest=nektos/act-environments-ubuntu:18.04 -j prod

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: ["master"]
  schedule:
    - cron: '0 11 * * *'
    - cron: '0 17 * * *'
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "prod"
  prod:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    # if: "github.repository == 'corona-warn-app/cwa-website'"

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Install requirements
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh
          sudo apt-get install -y libnode-dev libssl-dev automake npm nodejs libpng-dev libjpeg-dev s3cmd

      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3

      - name: Setup Node.js 18 environment
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/hydrogen'

      - name: npm install
        run: npm install

      - name: gulp build
        run: npm run build

      - name: keepalive.html
        run: echo "OK" > public/keepalive.html
      
      # https://github.com/s3tools/s3cmd/issues/643
      - name: Remove python3-magic due to s3cmd incompatibility
        run: sudo dpkg --remove --force-depends python3-magic

#      - name: Deployment
#        id: deploy-to-webapp
#        uses: azure/webapps-deploy@v2
#        with:
#          app-name: 'cwa-website'
#          slot-name: 'Production'
#          publish-profile: ${{ secrets.DIGITAL_CUISINE_DEPLOYMENT }}
#          package: public
          
      - name: Deployment 
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.DEPLOYMENT_SERVER }}
          username: ${{ secrets.DEPLOYMENT_USER }}
          password: ${{ secrets.DEPLOYMENT_PASS }}
          protocol: ftps
          security: strict
          port: 990
          local-dir: public/
          server-dir: '/site/wwwroot/'
    
